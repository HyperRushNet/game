<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fallen Kingdom Map Editor</title>
<style>
body { margin:0; display:flex; height:100vh; font-family:'Segoe UI',sans-serif; background:#111; color:#fff; }
#editor { flex:1; position:relative; cursor:crosshair; overflow:hidden; background:linear-gradient(135deg,#1a1a1a,#222); }
canvas { display:block; }
#sidebar { width:320px; background:#0c0c0c; padding:20px; overflow-y:auto; box-shadow:0 0 20px #000; border-left:1px solid #0ff; }
h2 { margin:10px 0; font-size:20px; font-weight:600; color:#0ff; border-bottom:1px solid #0ff; padding-bottom:5px; }
label { display:block; margin-top:12px; font-size:14px; color:#aaa; }
input, select, textarea, button { width:100%; margin-top:6px; background:#111; color:#0ff; border:1px solid #0ff; padding:6px; border-radius:6px; font-family:monospace; font-size:13px; transition:0.2s; }
input:focus, select:focus, textarea:focus { outline:none; border-color:#0f0; box-shadow:0 0 8px #0f0; }
button { cursor:pointer; border:1px solid #0ff; color:#0ff; background:transparent; transition:0.2s; }
button:hover { background:#0ff; color:#000; }
textarea { height:120px; resize:none; }
</style>
</head>
<body>
<div id="editor">
  <canvas id="canvas"></canvas>
</div>
<div id="sidebar">
  <h2>JSON Import / Export</h2>
  <textarea id="jsonIn" placeholder="Paste JSON here"></textarea>
  <button id="loadJsonBtn">Load JSON</button>

  <h2>Selected Object</h2>
  <label>Type
    <select id="propType"><option value="platform">Platform</option><option value="wall">Wall</option><option value="decor">Decor</option></select>
  </label>
  <label>Layer
    <select id="propLayer"><option value="front">Front</option><option value="behind">Behind</option></select>
  </label>
  <label>X <input type="number" id="propX"></label>
  <label>Y <input type="number" id="propY"></label>
  <label>Width <input type="number" id="propW"></label>
  <label>Height <input type="number" id="propH"></label>
  <label>Rotation <input type="number" id="propAngle"></label>
  <label>Texture URL <input type="text" id="propTextureUrl"></label>

  <h2>Player</h2>
  <label>X <input type="number" id="playerX"></label>
  <label>Y <input type="number" id="playerY"></label>
  <label>Width <input type="number" id="playerW"></label>
  <label>Height <input type="number" id="playerH"></label>

  <h2>Live JSON</h2>
  <textarea id="jsonOut" readonly></textarea>
</div>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth-320;
canvas.height=window.innerHeight;

let camX=0, camY=0, isPanning=false, panStartX=0, panStartY=0;
let objects=[], selected=null, dragging=false, dragOffsetX=0, dragOffsetY=0;
let player={x:200,y:200,w:50,h:50};

const propType=document.getElementById("propType");
const propLayer=document.getElementById("propLayer");
const propX=document.getElementById("propX");
const propY=document.getElementById("propY");
const propW=document.getElementById("propW");
const propH=document.getElementById("propH");
const propAngle=document.getElementById("propAngle");
const propTextureUrl=document.getElementById("propTextureUrl");
const playerX=document.getElementById("playerX");
const playerY=document.getElementById("playerY");
const playerW=document.getElementById("playerW");
const playerH=document.getElementById("playerH");
const jsonOut=document.getElementById("jsonOut");
const jsonIn=document.getElementById("jsonIn");
const loadJsonBtn=document.getElementById("loadJsonBtn");

function draw(){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(-camX,-camY);

  const behind=objects.filter(o=>o.layer==="behind");
  const front=objects.filter(o=>o.layer!=="behind");
  [...behind,...front].forEach(o=>{
    ctx.save();
    ctx.translate(o.x,o.y);
    ctx.rotate((o.angle||0)*Math.PI/180);
    ctx.fillStyle=o.type==="platform"?"#444":o.type==="wall"?"#666":"#880088";
    ctx.fillRect(-o.w/2,-o.h/2,o.w,o.h);
    if(o.texture){
      const img=new Image();
      img.src=o.texture;
      ctx.drawImage(img,-o.w/2,-o.h/2,o.w,o.h);
    }
    if(o===selected){
      ctx.strokeStyle="cyan";
      ctx.lineWidth=3;
      ctx.strokeRect(-o.w/2,-o.h/2,o.w,o.h);
    }
    ctx.restore();
  });

  ctx.fillStyle="lime";
  ctx.fillRect(player.x,player.y,player.w,player.h);
  ctx.strokeStyle="#0ff";
  ctx.lineWidth=2;
  ctx.strokeRect(player.x,player.y,player.w,player.h);
  ctx.fillStyle="#fff";
  ctx.fillText("PLAYER",player.x+5,player.y+15);

  ctx.restore();
}

function updateProps(){
  if(selected){
    propType.value=selected.type||"platform";
    propLayer.value=selected.layer||"front";
    propX.value=Math.round(selected.x);
    propY.value=Math.round(selected.y);
    propW.value=Math.round(selected.w);
    propH.value=Math.round(selected.h);
    propAngle.value=Math.round(selected.angle||0);
    propTextureUrl.value=selected.texture||"";
  }
  playerX.value=player.x; playerY.value=player.y;
  playerW.value=player.w; playerH.value=player.h;
  updateJSON();
}

function applyProps(){
  if(selected){
    selected.type=propType.value;
    selected.layer=propLayer.value||"front";
    selected.x=parseInt(propX.value);
    selected.y=parseInt(propY.value);
    selected.w=parseInt(propW.value);
    selected.h=parseInt(propH.value);
    selected.angle=parseFloat(propAngle.value)||0;
    selected.texture=propTextureUrl.value||null;
  }
  player.x=parseInt(playerX.value);
  player.y=parseInt(playerY.value);
  player.w=parseInt(playerW.value);
  player.h=parseInt(playerH.value);
  draw();
  updateJSON();
}
[propType, propLayer, propX, propY, propW, propH, propAngle, propTextureUrl, playerX, playerY, playerW, playerH].forEach(i=>i.addEventListener("input", applyProps));

function updateJSON(){
  const textures=[];
  objects.forEach(o=>{if(o.texture&&!textures.includes(o.texture)) textures.push(o.texture);});
  const platforms=objects.filter(o=>o.type==="platform"||o.type==="wall").map((o,i)=>({x:o.x,y:o.y,w:o.w,h:o.h,angle:o.angle||0,id:o.id||("obj"+i),textureId:o.texture?textures.indexOf(o.texture):null,type:o.type}));
  const decor=objects.filter(o=>o.type==="decor").map((o,i)=>({x:o.x,y:o.y,w:o.w,h:o.h,angle:o.angle||0,id:o.id||("objD"+i),textureId:o.texture?textures.indexOf(o.texture):null,layer:o.layer||"front"}));
  const json={playerStart:player,textures,platforms,decor};
  jsonOut.value=JSON.stringify(json,null,2);
}

function pointInRotatedRect(px,py,o){
  const rad=-o.angle*Math.PI/180;
  const dx=px-o.x;
  const dy=py-o.y;
  const localX=dx*Math.cos(rad)-dy*Math.sin(rad);
  const localY=dx*Math.sin(rad)+dy*Math.cos(rad);
  return localX>=-o.w/2 && localX<=o.w/2 && localY>=-o.h/2 && localY<=o.h/2;
}

canvas.addEventListener("mousedown",e=>{
  const x=e.offsetX+camX,y=e.offsetY+camY;
  if(e.shiftKey){ isPanning=true; panStartX=e.clientX; panStartY=e.clientY; return; }

  let clicked=null;
  for(let i=objects.length-1;i>=0;i--){
    if(pointInRotatedRect(x,y,objects[i])){ clicked=objects[i]; break; }
  }

  if(clicked){ selected=clicked; dragging=true; dragOffsetX=x-selected.x; dragOffsetY=y-selected.y; }
  else { selected={x:x,y:y,w:100,h:20,angle:0,texture:null,type:"platform",layer:"front"}; objects.push(selected); dragging=true; dragOffsetX=0; dragOffsetY=0; }
  updateProps(); draw();
});

canvas.addEventListener("mousemove",e=>{
  const x=e.offsetX+camX,y=e.offsetY+camY;
  if(isPanning){ camX-=(e.clientX-panStartX); camY-=(e.clientY-panStartY); panStartX=e.clientX; panStartY=e.clientY; draw(); }
  else if(dragging&&selected){ selected.x=x-dragOffsetX; selected.y=y-dragOffsetY; updateProps(); draw(); }
});

canvas.addEventListener("mouseup",()=>{dragging=false; isPanning=false;});

canvas.addEventListener("contextmenu",e=>{
  e.preventDefault();
  if(selected){ objects=objects.filter(o=>o!==selected); selected=null; updateJSON(); draw(); }
});

window.addEventListener("resize",()=>{canvas.width=window.innerWidth-320; canvas.height=window.innerHeight; draw();});

loadJsonBtn.addEventListener("click",()=>{
  try{
    const data=JSON.parse(jsonIn.value);
    player={...data.playerStart};
    objects=[];
    (data.platforms||[]).forEach(p=>objects.push({...p,type:p.type,layer:"front",texture:data.textures?.[p.textureId]||null}));
    (data.decor||[]).forEach(d=>objects.push({...d,type:"decor",layer:d.layer||"front",texture:data.textures?.[d.textureId]||null}));
    selected=null;
    draw(); updateProps();
  }catch(err){alert("Invalid JSON: "+err);}
});

window.addEventListener("keydown",e=>{
  if(!selected) return;
  switch(e.key){
    case "ArrowLeft": selected.x-=5; break;
    case "ArrowRight": selected.x+=5; break;
    case "ArrowUp": selected.y-=5; break;
    case "ArrowDown": selected.y+=5; break;
    default: return;
  }
  updateProps(); draw();
});

function animate(){ draw(); requestAnimationFrame(animate); }
animate();
</script>
</body>
</html>
