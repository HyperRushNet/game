<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Map Maker</title>
<style>
body { margin:0; display:flex; height:100vh; font-family:sans-serif; }
#editor { flex:1; position:relative; background:#222; overflow:hidden; }
canvas { width:100%; height:100%; display:block; cursor:crosshair; }
#sidebar { width:300px; background:#111; color:white; padding:10px; overflow-y:auto; }
h2 { margin:10px 0; font-size:18px; }
label { display:block; margin-top:8px; font-size:14px; }
input, select, textarea { width:100%; margin-top:3px; }
textarea { background:#000; color:#0f0; font-family:monospace; font-size:12px; }
#jsonIn { height:100px; color:#0ff; background:#000; margin-bottom:10px; }
</style>
</head>
<body>
<div id="editor">
  <canvas id="canvas"></canvas>
</div>
<div id="sidebar">
  <h2>JSON Import</h2>
  <textarea id="jsonIn" placeholder="Plak hier JSON en druk Load"></textarea>
  <button id="loadJsonBtn">Load JSON</button>

  <h2>Object eigenschappen</h2>
  <div id="props">
    <label>Type
      <select id="propType">
        <option value="platform">Platform</option>
        <option value="decor">Decor</option>
      </select>
    </label>
    <label>Layer (decor)
      <select id="propLayer">
        <option value="">(geen)</option>
        <option value="behind">Behind</option>
        <option value="front">Front</option>
      </select>
    </label>
    <label>X <input type="number" id="propX"></label>
    <label>Y <input type="number" id="propY"></label>
    <label>Breedte <input type="number" id="propW"></label>
    <label>Hoogte <input type="number" id="propH"></label>
    <label>Rotatie (Â°) <input type="number" id="propAngle"></label>
    <label>Texture
      <select id="propTexture">
        <option value="">Geen</option>
      </select>
    </label>
    <label>Custom URL <input type="text" id="propTextureUrl"></label>
  </div>

  <h2>Player Spawn</h2>
  <label>X <input type="number" id="playerX"></label>
  <label>Y <input type="number" id="playerY"></label>
  <label>Breedte <input type="number" id="playerW"></label>
  <label>Hoogte <input type="number" id="playerH"></label>

  <h2>Live JSON</h2>
  <textarea id="jsonOut" readonly></textarea>
</div>

<script>
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
canvas.width=window.innerWidth-300;
canvas.height=window.innerHeight;

let camX=0,camY=0,isPanning=false,panLastX=0,panLastY=0;
let objects=[],selected=null,dragging=false,offsetX=0,offsetY=0;
let textures=[];
let player={x:200,y:200,w:50,h:50};

const propType=document.getElementById("propType");
const propLayer=document.getElementById("propLayer");
const propX=document.getElementById("propX");
const propY=document.getElementById("propY");
const propW=document.getElementById("propW");
const propH=document.getElementById("propH");
const propAngle=document.getElementById("propAngle");
const propTexture=document.getElementById("propTexture");
const propTextureUrl=document.getElementById("propTextureUrl");
const playerX=document.getElementById("playerX");
const playerY=document.getElementById("playerY");
const playerW=document.getElementById("playerW");
const playerH=document.getElementById("playerH");
const jsonOut=document.getElementById("jsonOut");
const jsonIn=document.getElementById("jsonIn");
const loadJsonBtn=document.getElementById("loadJsonBtn");

function updateTextureOptions(){
  propTexture.innerHTML='<option value="">Geen</option>';
  textures.forEach(t=>propTexture.innerHTML+=`<option value="${t}">${t}</option>`);
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  for(const obj of objects){
    const drawX=obj.x-camX,drawY=obj.y-camY;
    ctx.save();
    ctx.translate(drawX,drawY);
    ctx.rotate((obj.angle||0)*Math.PI/180);
    ctx.fillStyle=obj===selected?'orange':'gray';
    ctx.fillRect(-obj.w/2,-obj.h/2,obj.w,obj.h);
    if(obj===selected){
      ctx.strokeStyle="yellow";ctx.lineWidth=2;
      ctx.strokeRect(-obj.w/2,-obj.h/2,obj.w,obj.h);
    }
    ctx.restore();
  }
  ctx.fillStyle="lime";
  ctx.fillRect(player.x-camX,player.y-camY,player.w,player.h);
  ctx.strokeStyle="yellow";ctx.strokeRect(player.x-camX,player.y-camY,player.w,player.h);
  ctx.fillStyle="white";ctx.fillText("PLAYER",player.x-camX+5,player.y-camY+15);
}

function updateProps(){
  if(selected){
    propType.value=selected.type||"platform";
    propLayer.value=selected.layer||"";
    propX.value=Math.round(selected.x);
    propY.value=Math.round(selected.y);
    propW.value=Math.round(selected.w);
    propH.value=Math.round(selected.h);
    propAngle.value=Math.round(selected.angle||0);
    propTextureUrl.value=selected.texture||"";
  }
  playerX.value=player.x;playerY.value=player.y;
  playerW.value=player.w;playerH.value=player.h;
  updateJSON();
}

function applyProps(){
  if(selected){
    selected.type=propType.value;
    selected.layer=propLayer.value||null;
    selected.x=parseInt(propX.value);selected.y=parseInt(propY.value);
    selected.w=parseInt(propW.value);selected.h=parseInt(propH.value);
    selected.angle=parseFloat(propAngle.value)||0;
    selected.texture=(propTextureUrl.value.trim()||propTexture.value)||null;
    updateTextureOptions();
  }
  player.x=parseInt(playerX.value);
  player.y=parseInt(playerY.value);
  player.w=parseInt(playerW.value);
  player.h=parseInt(playerH.value);
  draw();updateJSON();
}
[propType,propLayer,propX,propY,propW,propH,propAngle,propTexture,propTextureUrl,playerX,playerY,playerW,playerH]
.forEach(inp=>inp.addEventListener("input",applyProps));

function updateJSON(){
  const texturesMap=[];
  const platforms=[],decor=[];
  objects.forEach((o,i)=>{
    let texId=null;
    if(o.texture){
      let idx=texturesMap.indexOf(o.texture);
      if(idx===-1){texturesMap.push(o.texture);idx=texturesMap.length-1;}
      texId=idx;
    }
    const base={x:o.x,y:o.y,w:o.w,h:o.h,id:o.id||"obj"+i,textureId:texId,angle:o.angle||0};
    if(o.type==="decor"){
      base.layer=o.layer||"";
      decor.push(base);
    }else{
      platforms.push(base);
    }
  });
  const json={playerStart:player,textures:texturesMap,platforms,decor};
  jsonOut.value=JSON.stringify(json,null,2);
}

canvas.addEventListener("mousedown",e=>{
  const x=e.offsetX+camX,y=e.offsetY+camY;
  for(let i=objects.length-1;i>=0;i--){
    const o=objects[i];
    if(x>=o.x-o.w/2 && x<=o.x+o.w/2 && y>=o.y-o.h/2 && y<=o.y+o.h/2){
      selected=o;offsetX=x-o.x;offsetY=y-o.y;dragging=true;updateProps();draw();return;
    }
  }
  selected={x:x,y:y,w:100,h:20,angle:0,texture:null,type:"platform",layer:null};
  objects.push(selected);offsetX=0;offsetY=0;dragging=true;updateProps();draw();
});
canvas.addEventListener("mousemove",e=>{
  if(dragging&&selected){
    const x=e.offsetX+camX,y=e.offsetY+camY;
    selected.x=x-offsetX;selected.y=y-offsetY;
    updateProps();draw();
  }
});
canvas.addEventListener("mouseup",()=>dragging=false);
canvas.addEventListener("contextmenu",e=>{e.preventDefault();if(selected){objects=objects.filter(o=>o!==selected);selected=null;updateJSON();draw();}});

window.addEventListener("resize",()=>{canvas.width=window.innerWidth-300;canvas.height=window.innerHeight;draw();});

loadJsonBtn.addEventListener("click",()=>{
  try{
    const data=JSON.parse(jsonIn.value);
    player={...data.playerStart};
    objects=[];
    (data.platforms||[]).forEach(p=>objects.push({...p,texture:data.textures?.[p.textureId]||null,type:"platform"}));
    (data.decor||[]).forEach(d=>objects.push({...d,texture:data.textures?.[d.textureId]||null,type:"decor"}));
    textures=data.textures||[];updateTextureOptions();draw();updateProps();
  }catch(err){alert("Fout in JSON: "+err);}
});

draw();
</script>
</body>
</html>
