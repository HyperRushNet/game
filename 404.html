<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>HyperRush Games</title>
  <script src="/assets/js/pluginLoader.min.js?v=20250806"></script>
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token":"d9015ed7ad024103898a16365fea2d81"}'></script>
  <style>
    html,body{height:100%;margin:0;padding:0;overflow:hidden;font-family:Arial,sans-serif;background:#000;color:#fff}
    iframe{width:100%;height:100%;border:0;display:none;position:absolute;inset:0;z-index:1}
    #loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.95);z-index:9999;color:#fff}
    #loader div{width:40px;height:40px;border:4px solid currentColor;border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    #redirect-block-notice{position:fixed;top:12px;right:12px;background:rgba(0,0,0,.85);color:#fff;padding:10px 16px;border-radius:8px;z-index:10000;font-size:14px;display:flex;align-items:center;gap:12px;transition:opacity .4s;pointer-events:auto}
    #redirect-block-notice button.close-notice{background:none;border:none;color:#fff;font-size:20px;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center}
    #redirect-block-notice button.close-notice:hover{color:#ff6b6b}
    #redirect-block-notice.show{animation:slideIn .35s forwards,slideOut .35s forwards 2.6s}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
  </style>
</head>
<body>
  <div id="loader"><div></div></div>
  <div id="redirect-block-notice" aria-live="polite" role="status">
    <span id="notice-text"></span>
    <button class="close-notice" aria-label="Close notice">Ã—</button>
  </div>

  <script>
    const SETTINGS_KEY="userSettings";
    const loader=document.getElementById("loader");
    const notice=document.getElementById("redirect-block-notice");
    const noticeText=document.getElementById("notice-text");
    let iframe=null;
    let currentRedirectBlock=null;
    let currentGame=null;
    let gamesData=null;

    function readSettings(){try{const raw=localStorage.getItem(SETTINGS_KEY);const parsed=raw?JSON.parse(raw):{};return{redirectBlockSwitch:parsed.redirectBlockSwitch!==undefined?!!parsed.redirectBlockSwitch:true}}catch(e){return{redirectBlockSwitch:true}}}

    function showNotice(text){noticeText.textContent=text;notice.classList.remove("show");void notice.offsetWidth;notice.classList.add("show")}

    function injectMinimal(ifr,blockLogs){
      try{
        const doc=ifr.contentDocument||ifr.contentWindow?.document;
        if(!doc||!doc.head)return;

        const fps=doc.createElement("script");
        fps.textContent=`(function(){let last=0;function loop(ts){if(!last||ts-last>16.6){try{window.__updateGame?.();window.__renderGame?.()}catch(e){}last=ts}requestAnimationFrame(loop)}requestAnimationFrame(loop)})();`;
        doc.head.appendChild(fps);

        const vis=doc.createElement("script");
        vis.textContent=`document.addEventListener("visibilitychange",()=>{try{document.hidden?window.__pauseGame?.():window.__resumeGame?.()}catch(e){}});`;
        doc.head.appendChild(vis);

        const passive=doc.createElement("script");
        passive.textContent=`["touchstart","touchmove","wheel","keydown","keyup"].forEach(ev=>addEventListener(ev,()=>{},{passive:true}));`;
        doc.head.appendChild(passive);

        if(blockLogs){
          const noLogs=doc.createElement("script");
          noLogs.textContent=`(function(){const n=()=>{};console.log=console.debug=console.info=console.warn=console.error=n;})();`;
          doc.head.appendChild(noLogs);
        }
      }catch(e){}
    }

    function createIframeForGame(redirectBlock){
      if(iframe){iframe.remove();iframe=null}
      if(!currentGame)return;

      const newIframe=document.createElement("iframe");
      newIframe.src=currentGame.link;
      newIframe.allowFullscreen=true;

      let sb="allow-scripts allow-same-origin allow-pointer-lock allow-modals allow-popups allow-forms allow-top-navigation allow-presentation";
      if(!redirectBlock)sb+=" allow-popups-to-escape-sandbox allow-orientation-lock";

      newIframe.setAttribute("sandbox",sb);
      newIframe.setAttribute("referrerpolicy","no-referrer");

      newIframe.onload=()=>{
        injectMinimal(newIframe,!!redirectBlock);
        loader.style.display="none";
        newIframe.style.display="block";
        newIframe.focus();
        newIframe.contentWindow?.focus();
        setTimeout(()=>{newIframe.focus();newIframe.contentWindow?.focus()},300);
        setTimeout(()=>{newIframe.focus();newIframe.contentWindow?.focus()},800);
        showNotice(`Redirect block: ${redirectBlock?"ON":"OFF"}`);
        initAutoFocusManagement();
      };

      newIframe.onerror=()=>{location.href="/"};

      document.body.appendChild(newIframe);
      iframe=newIframe;
      currentRedirectBlock=!!redirectBlock;
      setTimeout(()=>newIframe.focus(),100);
    }

    function initAutoFocusManagement(){
      if(!iframe)return;
      document.addEventListener("click",e=>{
        if(!iframe)return;
        const t=e.target;
        if(t===iframe||iframe.contains(t))return;
        if(t.matches("button,input,textarea,select,a,[tabindex]:not([tabindex=\"-1\"])")||(t.hasAttribute("tabindex")&&t.getAttribute("tabindex")!=="-1"))return;
        let el=t;while(el&&el!==document.body){if(el.onclick||el.getAttribute?.("onclick"))return;el=el.parentElement}
        iframe.focus();iframe.contentWindow?.focus();setTimeout(()=>{iframe.focus();iframe.contentWindow?.focus()},50)
      },true);

      document.addEventListener("touchstart",e=>{
        if(!iframe)return;
        const t=e.target;
        if(t===iframe||iframe.contains(t))return;
        if(t.closest?.("button,input,textarea,select,a,[role=\"button\"],[tabindex]")||t.onclick)return;
        iframe.focus();iframe.contentWindow?.focus()
      },true);

      document.addEventListener("mousemove",e=>{
        if(!iframe)return;
        const t=e.target;
        if(t===iframe||iframe.contains(t))return;
        if(t.closest?.("button,input,a,[role=\"button\"],[tabindex]"))return;
        if(document.activeElement!==iframe)iframe.focus()
      });

      document.addEventListener("visibilitychange",()=>{if(!document.hidden&&iframe)setTimeout(()=>{iframe.focus();iframe.contentWindow?.focus()},150)})
    }

    async function loadGamesJSON(timeoutMs=5000){
      try{
        const c=new AbortController();
        const id=setTimeout(()=>c.abort(),timeoutMs);
        const r=await fetch("/assets/json/games.json",{signal:c.signal});
        clearTimeout(id);
        if(!r.ok)throw new Error("fetch failed");
        return await r.json()
      }catch(e){return null}
    }

    function getGameIdFromPath(){
      const parts=window.location.pathname.split("/").filter(p=>p);
      if(parts.length===0)return null;
      const id=parseInt(parts[parts.length-1],10);
      return isNaN(id)?null:id
    }

    async function loadGame(){
      document.title="Loading... | HyperRush";
      loader.style.display="flex";
      const num=getGameIdFromPath();
      if(!num)return location.href="/";
      if(!gamesData){gamesData=await loadGamesJSON();if(!gamesData)return location.href="/"}
      currentGame=gamesData.find(g=>Number(g.number)===num);
      if(!currentGame)return location.href="/";
      document.title=`${currentGame.name} | HyperRush`;
      const s=readSettings();
      createIframeForGame(!!s.redirectBlockSwitch)
    }

    function handleSettingsChange(ns){
      const rb=!!(ns&&ns.redirectBlockSwitch);
      if(currentRedirectBlock===null){currentRedirectBlock=rb;return}
      if(rb!==currentRedirectBlock){
        showNotice(`Redirect block: ${rb?"ON":"OFF"}`);
        loader.style.display="flex";
        createIframeForGame(rb)
      }else{showNotice(`Redirect block: ${rb?"ON":"OFF"}`)}
    }

    window.addEventListener("storage",e=>{
      if(e.key===SETTINGS_KEY){
        try{const p=e.newValue?JSON.parse(e.newValue):{};handleSettingsChange({redirectBlockSwitch:p.redirectBlockSwitch!==undefined?!!p.redirectBlockSwitch:true})}
        catch(_){handleSettingsChange({redirectBlockSwitch:true})}
      }
    });

    window.addEventListener("userSettingsChanged",e=>{if(e?.detail)handleSettingsChange(e.detail)});

    window.addEventListener("popstate",()=>{if(iframe){iframe.remove();iframe=null}loadGame()});

    document.querySelector(".close-notice")?.addEventListener("click",()=>{notice.style.display="none"});

    document.addEventListener("DOMContentLoaded",loadGame);
  </script>
</body>
</html>
