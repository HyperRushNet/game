<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex,nofollow" />
  <title>HyperRush Games</title>
  <script src="/assets/js/pluginLoader.min.js?v=20250806"></script>
  <script defer src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token":"d9015ed7ad024103898a16365fea2d81"}'></script>
  <style>
    html,body{height:100%;margin:0;padding:0;overflow:hidden;font-family:Arial,sans-serif;background:#000;color:#fff;position:relative}
    iframe{width:100%;height:100%;border:0;position:absolute;inset:0;z-index:1;opacity:0;transition:opacity .6s}
    iframe.loaded{opacity:1}
    #loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;z-index:9999;flex-direction:column;gap:20px;transition:opacity .6s}
    #loader div{width:50px;height:50px;border:5px solid #fff;border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite}
    #loader span{font-size:18px}
    @keyframes spin{to{transform:rotate(360deg)}}
    #game-overlay{position:absolute;inset:0;z-index:2;background:#000;pointer-events:auto;cursor:crosshair;transition:opacity 1s}
    #game-overlay canvas{width:100%;height:100%;display:block}
    #redirect-block-notice{position:fixed;top:12px;right:12px;background:rgba(0,0,0,.85);color:#fff;padding:10px 16px;border-radius:8px;z-index:10000;font-size:14px;display:flex;align-items:center;gap:12px;transition:opacity .4s}
    #redirect-block-notice button.close-notice{background:none;border:none;color:#fff;font-size:20px;cursor:pointer}
    #redirect-block-notice button.close-notice:hover{color:#ff6b6b}
    #redirect-block-notice.show{animation:slideIn .35s forwards,slideOut .35s forwards 3s}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
    @keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}
  </style>
</head>
<body>
  <div id="loader">
    <div></div>
    <span>Loading game...</span>
  </div>
  <div id="game-overlay">
    <canvas id="particles"></canvas>
    <div style="position:absolute;bottom:20px;left:50%;transform:translateX(-50%);color:#fff;font-size:18px;pointer-events:none">
      Click & move mouse to interact • Game loading in background...
    </div>
  </div>
  <div id="redirect-block-notice" aria-live="polite" role="status">
    <span id="notice-text"></span>
    <button class="close-notice" aria-label="Close notice">×</button>
  </div>

  <script>
    const SETTINGS_KEY = "userSettings";
    const loader = document.getElementById("loader");
    const overlay = document.getElementById("game-overlay");
    const notice = document.getElementById("redirect-block-notice");
    const noticeText = document.getElementById("notice-text");
    let iframe = null;
    let currentRedirectBlock = null;
    let currentGame = null;
    let gamesData = null;

    // Simple interactive particle system for instant feedback
    const canvas = document.getElementById("particles");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    window.addEventListener("resize", () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });

    let particles = [];
    let mouse = { x: null, y: null };
    canvas.addEventListener("mousemove", e => { mouse.x = e.clientX; mouse.y = e.clientY; });
    canvas.addEventListener("click", () => {
      for (let i = 0; i < 30; i++) createParticle(mouse.x, mouse.y, "#00ffcc");
    });

    function createParticle(x, y, color = "#ffffff") {
      particles.push({
        x: x || Math.random() * canvas.width,
        y: y || -10,
        vx: (Math.random() - 0.5) * 3,
        vy: Math.random() * 3 + 1,
        radius: Math.random() * 4 + 2,
        color,
        alpha: 1
      });
    }

    function animateParticles() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      particles.forEach((p, i) => {
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.05; // gravity
        p.alpha -= 0.005;
        if (p.alpha <= 0 || p.y > canvas.height + 10) particles.splice(i, 1);

        ctx.beginPath();
        ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
        ctx.fillStyle = `rgba(${parseInt(p.color.slice(1,3),16)},${parseInt(p.color.slice(3,5),16)},${parseInt(p.color.slice(5,7),16)},${p.alpha})`;
        ctx.fill();

        // Attract to mouse
        if (mouse.x && mouse.y) {
          let dx = mouse.x - p.x;
          let dy = mouse.y - p.y;
          let dist = Math.sqrt(dx*dx + dy*dy);
          if (dist < 150) {
            p.vx += dx / dist * 0.3;
            p.vy += dy / dist * 0.3;
          }
        }
      });
      requestAnimationFrame(animateParticles);
    }

    // Start falling particles + interaction immediately
    setInterval(() => createParticle(), 100);
    animateParticles();

    function readSettings() {
      try {
        const raw = localStorage.getItem(SETTINGS_KEY);
        const parsed = raw ? JSON.parse(raw) : {};
        return { redirectBlockSwitch: parsed.redirectBlockSwitch !== undefined ? !!parsed.redirectBlockSwitch : true };
      } catch (e) { return { redirectBlockSwitch: true }; }
    }

    function showNotice(text) {
      noticeText.textContent = text;
      notice.classList.remove("show");
      void notice.offsetWidth;
      notice.classList.add("show");
    }

    function injectMinimal(ifr, blockLogs) {
      try {
        const doc = ifr.contentDocument || ifr.contentWindow?.document;
        if (!doc || !doc.head) return;
        const scripts = [
          `(function(){let last=0;function loop(ts){if(!last||ts-last>16.6){try{window.__updateGame?.();window.__renderGame?.()}catch(e){}last=ts}requestAnimationFrame(loop)}requestAnimationFrame(loop)})();`,
          `document.addEventListener("visibilitychange",()=>{try{document.hidden?window.__pauseGame?.():window.__resumeGame?.()}catch(e){}});`,
          `["touchstart","touchmove","wheel","keydown","keyup"].forEach(ev=>addEventListener(ev,()=>{},{passive:true}));`,
          blockLogs ? `(function(){const n=()=>{};console.log=console.debug=console.info=console.warn=console.error=n;})();` : ""
        ];
        scripts.forEach(code => {
          const s = doc.createElement("script");
          s.textContent = code;
          doc.head.appendChild(s);
        });
      } catch (e) {}
    }

    function createIframeForGame(redirectBlock) {
      if (iframe) { iframe.remove(); iframe = null; }
      if (!currentGame) return;
      const newIframe = document.createElement("iframe");
      newIframe.src = currentGame.link;
      newIframe.allowFullscreen = true;
      let sb = "allow-scripts allow-same-origin allow-pointer-lock allow-modals allow-popups allow-forms allow-top-navigation allow-presentation";
      if (!redirectBlock) sb += " allow-popups-to-escape-sandbox allow-orientation-lock";
      newIframe.sandbox = sb;
      newIframe.referrerPolicy = "no-referrer";
      newIframe.loading = "eager"; // Start loading immediately

      newIframe.onload = () => {
        injectMinimal(newIframe, !!redirectBlock);
        newIframe.classList.add("loaded");
        overlay.style.opacity = "0";
        setTimeout(() => { overlay.style.display = "none"; }, 1000);
        newIframe.focus();
        newIframe.contentWindow?.focus();
        showNotice(`Redirect block: ${redirectBlock ? "ON" : "OFF"} • Game ready!`);
      };
      newIframe.onerror = () => { location.href = "/"; };

      document.body.appendChild(newIframe);
      iframe = newIframe;
      currentRedirectBlock = !!redirectBlock;
    }

    async function loadGamesJSON(timeoutMs = 5000) {
      try {
        const c = new AbortController();
        const id = setTimeout(() => c.abort(), timeoutMs);
        const r = await fetch("/assets/json/games.json", { signal: c.signal });
        clearTimeout(id);
        if (!r.ok) throw new Error("fetch failed");
        return await r.json();
      } catch (e) { return null; }
    }

    function getGameIdFromPath() {
      const parts = window.location.pathname.split("/").filter(p => p);
      if (parts.length === 0) return null;
      const id = parseInt(parts[parts.length - 1], 10);
      return isNaN(id) ? null : id;
    }

    async function loadGame() {
      document.title = "Loading... | HyperRush";
      const num = getGameIdFromPath();
      if (!num) return location.href = "/";
      if (!gamesData) { gamesData = await loadGamesJSON(); if (!gamesData) return location.href = "/"; }
      currentGame = gamesData.find(g => Number(g.number) === num);
      if (!currentGame) return location.href = "/";
      document.title = `${currentGame.name} | HyperRush`;

      const s = readSettings();
      createIframeForGame(!!s.redirectBlockSwitch);

      // Hide real loader quickly → show interactive overlay
      setTimeout(() => {
        loader.style.opacity = "0";
        setTimeout(() => { loader.style.display = "none"; }, 600);
      }, 400);
    }

    window.addEventListener("storage", e => {
      if (e.key === SETTINGS_KEY) {
        try {
          const p = e.newValue ? JSON.parse(e.newValue) : {};
          if (p.redirectBlockSwitch !== undefined && !!p.redirectBlockSwitch !== currentRedirectBlock) {
            createIframeForGame(!!p.redirectBlockSwitch);
          }
        } catch (_) {}
      }
    });

    document.querySelector(".close-notice")?.addEventListener("click", () => { notice.style.display = "none"; });
    window.addEventListener("popstate", () => { if (iframe) iframe.remove(); loadGame(); });
    document.addEventListener("DOMContentLoaded", loadGame);
  </script>
</body>
</html>
